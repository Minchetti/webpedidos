$(function(){function e(){$(document).tooltip({items:"[data-image]",track:!0,content:function(){var e=$(this),o=$.trim(e.data("partnumber").toString());if(e.is("[data-image]")){var t=$.trim(e.text());return'<figure><img class="img-responsive img-thumbnail" src="'+a+"/images/produtos/"+o+'.jpg" alt="'+t+'"><figcaption><small>'+t+"</small></figcaption></figure>"}}})}var a=document.location.origin+"/webpedidos/assets";sessionStorage.removeItem("pedido"),$("#btn-efetuar-solicitacao").click(function(o){o.preventDefault();var t=new Produtos,r=new Funcionario,s=new Requisicao;if($.isEmptyObject(t.getProdutoFromStorage())||$.isEmptyObject(r.getFuncionarioFromStorage()))bootbox.alert({size:"small",title:"<i class='glyphicon glyphicon-exclamation-sign'></i> Atenção",message:"Selecione ao menos um funcionário e um item",locale:"pt"});else{s.produtos(JSON.stringify(t.getProdutoFromStorage())),s.funcionarios(JSON.stringify(r.getFuncionarioFromStorage())),s.observacao($("#txtObservacao").val());var i=s.gerarPedido();JSON.parse(i.callback)?($.each(i.resumo,function(e,o){$("<tr>",{id:"pedido-"+e}).appendTo("#resumo-pedido-funcionarios"),$("<td>",{class:"text-center",text:o.pedido.pedido}).appendTo("#pedido-"+e),$("<td>",{class:"text-center",text:o.pedido.matricula}).appendTo("#pedido-"+e),$("<td>",{text:o.pedido.nome}).appendTo("#pedido-"+e),$("<td>",{text:o.pedido.entrega}).appendTo("#pedido-"+e),$("<td>",{text:o.pedido.turno}).appendTo("#pedido-"+e),0===e&&$.each(o.pedido.produto,function(e,o){$("<tr>",{id:"resumo-produtos-"+e}).appendTo("#resumo-pedido-produtos"),$("<td>",{class:"text-center",text:o.codigo_produto}).appendTo("#resumo-produtos-"+e),$("<td>",{text:"  "+o.descricao,"data-image":"","data-partnumber":o.partnumber,prepend:$("<img>",{src:a+"/images/produtos/"+o.partnumber+".jpg",width:"30",heigth:"30"})}).appendTo("#resumo-produtos-"+e),$("<td>",{class:"text-center",text:o.quantidade}).appendTo("#resumo-produtos-"+e)})}),$("#resumo-data-emissao").html(i.resumo[0].data_emissao),""!==i.resumo[0].obs&&($("#alert-observacao").addClass("alert-info"),$("#resumo-observacao").html(i.resumo[0].obs),$(".wrapper-observacao").css("display","block")),e(),$("#status-abertura-requisicao").html('<i class="glyphicon glyphicon-thumbs-up"></i> Requisição realizada com sucesso!').addClass("alert alert-success"),$("#resumo-pedido").modal("toggle"),$("#btn-cancelar-requisicao").trigger("click"),$("#tabFuncionario").tab("show")):bootbox.alert({size:"small",title:"<i class='glyphicon glyphicon-exclamation-sign'></i> Atenção",message:"Não foi possível concluir a requisição.",locale:"pt"})}}),$("#btn-cancelar-requisicao").click(function(e){e.preventDefault(),sessionStorage.removeItem("items"),sessionStorage.removeItem("funcionarios"),$("#funcionarios-selecionados > *").remove(),$("#produtos-selecionados > *").remove(),$("#reutilizar-pedido").parent().removeClass("active"),$("#sel-lote").parent().removeClass("active"),$("#sel-template").parent().removeClass("active"),$("#sel-funcionarios").parent().removeClass("active"),$("#txtObservacao").val("")}),$("#lista-funcionarios").click(function(e){e.preventDefault()}),$("#sel-funcionarios").click(function(e){e.preventDefault(),$(this).parent().toggleClass("active"),$("#sel-lote").parent().removeClass("active"),$("#sel-template").parent().removeClass("active"),$("#reutilizar-pedido").parent().removeClass("active"),setTimeout(function(){$("#txtFuncionario").focus()},1e3)}),$("#sel-lote").click(function(e){e.preventDefault(),$(this).parent().toggleClass("active"),$("#sel-funcionarios").parent().removeClass("active"),$("#sel-template").parent().removeClass("active"),$("#reutilizar-pedido").parent().removeClass("active"),setTimeout(function(){$("#txtSetor").focus()},1e3)}),$("#sel-template").click(function(e){e.preventDefault(),$(this).parent().toggleClass("active"),$("#sel-lote").parent().removeClass("active"),$("#sel-funcionarios").parent().removeClass("active"),$("#reutilizar-pedido").parent().removeClass("active"),$("#btn-buscarTemplate").trigger("click")}),$("#reutilizar-pedido").click(function(e){e.preventDefault(),$(this).parent().toggleClass("active"),$("#sel-lote").parent().removeClass("active"),$("#sel-template").parent().removeClass("active"),$("#sel-funcionarios").parent().removeClass("active")}),$("#resumo-pedido").on("hidden.bs.modal",function(){$("#resumo-pedido-funcionarios > *").remove(),$("#resumo-pedido-produtos > *").remove(),$("#alert-observacao").removeClass("alert-info"),$("#resumo-observacao").html(""),$("#resumo-data-emissao").html(""),$("#status-abertura-requisicao").html("").removeClass("alert alert-success")}),$("#detalhes-pedido").on("hidden.bs.modal",function(){$("#avisos-aprovar").removeClass("alert alert-success").removeClass("alert alert-danger"),$("#avisos-aprovar > * ").remove(),$("#motivo-nao-aprovado > *").remove(),$("#acao-nao-aprovado > *").remove(),$("#txtObservacao-caracter").html(0)}),$("#btn-aprovar").click(function(e){e.preventDefault();var a=new Requisicao,o=a.aprovar($("#num-pedido-detalhe").text(),!0,"");JSON.parse(o.callback)?($("#avisos-aprovar").addClass("alert alert-success"),$("<p>",{class:"text-center"}).html('<i class="fa fa-check" aria-hidden="true"></i> Solicitação aprovada com sucesso.<br /> Número do pedido <strong>'+o.reserva+'</strong>. <br /><small>O pedido poderá ser consultado no menu <strong><a href="localizar_requisicao">Pedidos</a></strong></small>').appendTo("#avisos-aprovar"),$(this).prop("disabled",!0),$("#btn-nao-aprovar").prop("disabled",!0),$('*[data-solicitacao="'+parseInt(o.solicitacao,10)+'"]').parent().remove(),sessionStorage.setItem("pedido",o.reserva)):($("#avisos-aprovar").addClass("alert alert-danger"),$("<p>",{class:"text-center"}).html('<i class="fa fa-times" aria-hidden="true"></i> Ocorreu um erro, por favor, informe o suporte técnico. <br /> Data e hora do ocorrido: '+(new Date).toLocaleString("pt-BR")).appendTo("#avisos-aprovar"))}),$("#btn-nao-aprovar").click(function(e){e.preventDefault(),$("<label>",{text:"Motivo"}).appendTo("#motivo-nao-aprovado"),$("<textarea>",{id:"txtMotivoNaoAprovado",class:"form-control",style:"resize: none; text-transform: uppercase;"}).appendTo("#motivo-nao-aprovado"),$("<label>",{text:" "}).appendTo("#acao-nao-aprovado"),$("<button>",{id:"btnNaoAprovado",class:"btn btn-primary pull-right",text:" Confirmar",style:"margin: 15px",click:function(){var e=new Requisicao,a=e.aprovar($("#num-pedido-detalhe").text(),!1,$("#txtMotivoNaoAprovado").val());JSON.parse(a.callback)?($("#avisos-aprovar").addClass("alert alert-success"),$("<p>",{class:"text-center"}).html('<i class="fa fa-check" aria-hidden="true"></i> Solicitação de Nº '+a.solicitacao+" não aprovada.").appendTo("#avisos-aprovar"),$("#btn-aprovar").prop("disabled",!0),$("#btn-nao-aprovar").prop("disabled",!0),$('*[data-solicitacao="'+parseInt(a.solicitacao,10)+'"]').parent().remove(),$("#btnNaoAprovado").prop("disabled",!0),$("#txtMotivoNaoAprovado").prop("readonly",!0)):($("#avisos-aprovar").addClass("alert alert-danger"),$("<p>",{class:"text-center"}).html('<i class="fa fa-times" aria-hidden="true"></i> Ocorreu um erro, por favor, informe o suporte técnico. <br /> Data e hora do ocorrido: '+(new Date).toLocaleString("pt-BR")).appendTo("#avisos-aprovar"))},prepend:$("<i>",{class:"fa fa-check","aria-hidden":!0})}).appendTo("#acao-nao-aprovado"),$("#txtMotivoNaoAprovado").focus()}),$("#txtObservacao").keyup(function(e){$(this).val().length>=0&&$(this).val().length<=1e3&&$("#txtObservacao-caracter").html($(this).val().length)}),$("#exportar-pdf").click(function(){var e=new jsPDF("p","pt","a4"),a=e.autoTableHtmlToJson($("#pdf-resumo-funcionarios").get(0)),o=e.autoTableHtmlToJson($("#pdf-resumo-produtos").get(0));e.setFontSize(12),e.text("Emissão: "+$("#resumo-data-emissao").text(),50,30),e.text("Observação: "+$("#resumo-observacao").text(),50,60),e.autoTable(a.columns,a.data,{startY:100,headerStyles:{fillColor:[188,0,9],fontSize:12}}),e.autoTable(o.columns,o.data,{startY:e.autoTable.previous.finalY+10,headerStyles:{fillColor:[188,0,9],fontSize:12}}),e.save("Resumo-"+(new Date).toLocaleString("pt-BR")+".pdf")})});